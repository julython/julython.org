var JULY=JULY||{};ko.bindingHandlers.pageBottom={init:function(a,b,c,d){var e=b(),f=c(),g=f.callbackThreshold||1e3,h=f.callbackInterval||500;if("function"!=typeof e)throw new Error("The value of the pageBottom binding must be a function");e=$.proxy(e,d);var i=$(document),j=$(window);setInterval(function(){i.height()-j.height()-j.scrollTop()<g&&e()},h)}},ko.bindingHandlers.timeago={init:function(a,b,c){var d=b();c();var e=ko.utils.unwrapObservable(d);$(a).attr("title",e),$(a).timeago()}},ko.bindingHandlers.typeahead={init:function(a,b,c){var d=b();c();var e=ko.utils.unwrapObservable(d);$(a).typeahead({source:e})}},JULY.ViewModel=function(){this.initialize.apply(this,arguments)},_.extend(JULY.ViewModel.prototype,{initialize:function(){}}),JULY.ViewModel.extend=Backbone.View.extend,JULY.applyBindings=function(a,b){var c=$(b);c.length>0?ko.applyBindings(a,c[0]):console.log('Binding error:  no elements found for "'+b+'"')},function(){var a=function(a,b){this._chartId=a,this._dataUrl=b,this._chartElement=$("#"+a),this._width=this._chartElement.width(),this._height=this._chartElement.height(),this._pad={top:0,left:0,right:0,bottom:0,barX:1,barY:1},this._options={},this._width&&this._height||(this._width=600,this._height=400),this._chart=d3.select("#"+this._chartId).append("svg"),this._chart.attr("class","chart").attr("width",this._width).attr("height",this._height)};a.prototype.load=function(a){return this._stats=a,this},a.prototype.set=function(a,b){var c=this["_set_"+a];return c?c.apply(this,[b]):console.log("No set for option '"+a+"'."),this},a.prototype._set_xLabel=function(a){this._options.xLabel=a,this._pad.bottom+=24},a.prototype._set_title=function(){},a.prototype._set_yLabel=function(a){this._pad.top+=20,this._options.yLabel=a},a.prototype._getChartDimensions=function(){for(var a=this._stats.length,b=this._width-(this._pad.left+this._pad.right)-a*this._pad.barX,c=this._height-(this._pad.bottom+this._pad.top),d=b/a,e=1,f=0;a>f;f++)this._stats[f]>e&&(e=this._stats[f]);return{bars:a,barWidth:d,maxValue:e,width:b,height:c,top:this._pad.top,bottom:this._height-this._pad.bottom,left:this._pad.left,right:this._width-this._pad.right}},a.prototype.render=function(){var a=this._getChartDimensions(),c=this._chart.selectAll("rect"),d=c.data(this._stats),e=d.enter(),f=this;this._addFilters(),e.append("rect").attr("x",function(b,c){return f._pad.left+c*(a.barWidth+1)}).attr("y",function(c){return a.top+(a.height-b(c,a.maxValue,a.height))}).attr("width",a.barWidth).attr("height",function(c){return b(c,a.maxValue,a.height)});for(var g in this._options)if(this._options.hasOwnProperty(g)){var h=this["_render_"+g];h?h.apply(this,[e,this._options[g]]):console.log("No rendering option for '"+g+"'.")}return this},a.prototype._addFilters=function(){var a=this._chart.append("filter").attr("id","dropshadow");a.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",.1),a.append("feOffset").attr("dx",0).attr("dy",1).attr("result","offsetblur");var b=a.append("feMerge");b.append("feMergeNode"),b.append("feMergeNode").attr("in","SourceGraphic")},a.prototype._render_xLabel=function(a,b){var d=this._getChartDimensions(),e=this;a.append("text").attr("class","xLabel").attr("x",function(a,b){return e._pad.left+(d.barWidth+e._pad.barX)*b+d.barWidth/2}).attr("y",function(){return e._pad.top+d.height+e._pad.bottom-3}).attr("width",d.barWidth).attr("text-anchor","middle").text(function(a,d){return c(b,a,d)}),this._chart.append("line").attr("class","rule").attr("y1",d.height+this._pad.top+2).attr("y2",d.height+this._pad.top+2).attr("x1",this._pad.left-2).attr("x2",this._pad.left+d.width+d.bars*this._pad.barX)},a.prototype._render_yLabel=function(a,d){var e=this._getChartDimensions(),f=this;a.append("text").attr("class","yLabel").attr("text-anchor","middle").attr("width",e.barWidth).attr("x",function(a,b){return f._pad.left+(e.barWidth+f._pad.barX)*b+e.barWidth/2}).attr("y",function(a){return console.log(e),f._pad.top+(e.height-b(a,e.maxValue,e.height))-5}).text(function(a,b){return c(d,a,b)})};var b=function(a,b,c){var d=a/b*c;return d},c=function(a,b,c){return $.isFunction(a)?a(b,c):a};window.Charts={BarChart:a}}();var JULY=JULY||{};if(JULY.Commit=Backbone.Model.extend({url:"/api/v1/commit/"}),JULY.CommitCalendarDay=Backbone.Model.extend({idAttribute:"timestamp"}),JULY.CommitCalendar=Backbone.Collection.extend({model:JULY.CommitCalendarDay,url:function(){return"/api/v1/commit/calendar/?"+this.params()},initialize:function(a,b){this.username=b.username||null,this.days=b.days||null,this.end_date=b.date||null},params:function(){var a={};return this.username&&(a.username=this.username),this.days&&(a.days=this.days),this.end_date&&this.end_date instanceof Date&&(a.end_date=this.end_date.toISOString()),jQuery.param(a)}}),JULY.CommitCollection=Backbone.Collection.extend({model:JULY.Commit,url:function(){return"/api/v1/commit/?"+this.params()},initialize:function(a,b){this.projectId=b.projectId,this.userId=b.userId,this.languages=b.languages||[],this.limit=b.limit||20,this.offset=b.offset||0,this.total=0,this.hasMore=!1,this._pushStream=new PushStream({host:window.location.hostname,port:window.location.port,modes:"websocket|stream",urlPrefixStream:"/events/sub",urlPrefixPublisher:"/events/pub",urlPrefixWebsocket:"/events/ws"}),JULY.collection=this,this._pushStream.onmessage=function(a){console.log("-- New commit from PushStream:",a),JULY.collection.unshift(a)},this._pushStream.onstatuschange=function(a){console.log("-- PushStream state changed: "+a),a===PushStream.CLOSED&&console.log("!! ERROR: PushStream was closed.")};var c=this.projectId?"project-"+this.projectId:this.userId?"user-"+this.userId:"global";console.log("-- Subscribing to PushStream channel: "+c),this._pushStream.addChannel(c),this._pushStream.connect()},params:function(){var a={limit:this.limit,offset:this.offset};return this.projectId&&(a.project=this.projectId),this.userId&&(a.user=this.userId),this.languages&&(a.languages=_(this.languages).reduce(function(a,b,c){var d=c>0;return a.concat((d?";":"")+b)},"",this)),jQuery.param(a)},parse:function(a){return this.total=a.meta.total_count,this.offset=a.meta.offset+this.limit,this.hasMore=this.total>this.models.length,a.objects}}),JULY.CommitsView=JULY.ViewModel.extend({initialize:function(a){this.c=new JULY.CommitCollection(null,a),this.c.fetch({add:!0}),this.commits=kb.collectionObservable(this.c)},hasMore:function(){return this.commits.collection().hasMore},scrolled:function(a,b){var c=b.target;c.scrollTop>c.scrollHeight-c.offsetHeight-200&&this.fetch()},fetch:function(){this.hasMore()&&this.commits.collection().fetch({remove:!1})}}),JULY.makeCalendar=function(a,b){var c=new Date,d=d3.time.day(c),e=d3.time.day.offset(c,-36),f=d3.time.days(e,d),g=d3.time.format("%Y-%m-%d"),h=_(f).map(function(a){var b={timestamp:g(a),commit_count:0};return b}),i=new JULY.CommitCalendar(h,{username:b});i.fetch({async:!1,remove:!1}),h=i.map(function(a){return a.get("commit_count")});var j=10,k=1,l=7,m=(j+2*k)*l,n=5*(j+2*k),o=d3.scale.linear().domain([0,Math.max.apply(null,h)]).range(["white","green"]),p=d3.select(a).attr("width",n).attr("height",m).style("background-color","#BEC9AF");p.selectAll("rect").data(h).enter().append("rect").attr("width",j).attr("height",j).attr("x",function(a,b){var c=Math.floor(b/l);return(j+2*k)*c+k}).attr("y",function(a,b){var c=b%l;return(j+2*k)*c+k}).style("fill",o)},!$)var $=null;if(!console)var console=null;var Nav=function(a,b){this._selector=a,this._el=$(a),this._offset=$(window).width()<979?0:b||0,this._startTop=this._el.position().top,this._sectionPadding=20,this._startPadding=Number(this._el.next().css("padding-top").replace("px","")),this._height=this._el.outerHeight()};Nav.prototype.setup=function(){var a=this;this._el.find("button").each(function(){var b=$(this);b.click(function(){var b=$("h2."+this.className),c=b.position().top-a._height-a._offset-a._sectionPadding;$("html, body").animate({scrollTop:c},1100)})})},Nav.prototype.update=function(){var a=$(window);a.scrollTop()+this._offset<this._startTop?(this._el.removeClass("fixed"),this._el.next().css("padding-top",this._startPadding+"px"),this._el.css("top",""),this._el.css("width","")):(this._el.addClass("fixed"),this._el.css("top",this._offset+"px"),this._el.next().css("padding-top",this._startPadding+this._height+"px"),this._el.css("width","100%"))};var JULY=JULY||{};JULY.Group=Backbone.Model.extend({url:"/api/v1/"}),JULY.GroupCollection=Backbone.Collection.extend({model:JULY.Group,initialize:function(a,b){var b=b||{};this.limit=b.limit||20,this.offset=b.offset||0,this.total=0,this.query="",this.hasMore=!1},params:function(){var a={limit:this.limit,offset:this.offset};return this.query&&(a.name__icontains=this.query),jQuery.param(a)},filter:function(a){return this.total=0,this.offset=0,this.query=a,this.fetch(),this.map(function(a){return a.get("name")})},parse:function(a){return this.total=a.meta.total_count,this.offset=a.meta.offset+this.limit,this.hasMore=this.total>this.models.length,a.objects}}),JULY.LocationCollection=JULY.GroupCollection.extend({url:function(){return"/api/v1/location/?"+this.params()}}),JULY.TeamCollection=JULY.GroupCollection.extend({url:function(){return"/api/v1/team/?"+this.params()}}),JULY.ProfileView=JULY.ViewModel.extend({initialize:function(){this.locations=kb.collectionObservable(new JULY.LocationCollection),this.teams=kb.collectionObservable(new JULY.TeamCollection),JULY.profile=this},filterLocation:function(a){return JULY.profile.locations.collection().filter(a)},filterTeam:function(a){return JULY.profile.teams.collection().filter(a)}});